<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tata Documents Assist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-scroll { height: calc(100vh - 300px); overflow-y: auto; }
        .markdown-body { font-family: sans-serif; line-height: 1.6; }
        
        /* Bouncing Dots Animation */
        .dot-flashing {
            position: relative;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9CA3AF;
            color: #9CA3AF;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9CA3AF;
            color: #9CA3AF;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9CA3AF;
            color: #9CA3AF;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dot-flashing {
            0% { background-color: #9CA3AF; }
            50%, 100% { background-color: #E5E7EB; }
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col">

    <header class="bg-white shadow-sm border-b px-6 py-4 flex justify-between items-center z-10">
        <div class="flex items-center gap-3">
             <img src="{{ url_for('static', filename='tata.png') }}" alt="Tata Logo" class="h-10 w-auto object-contain">
            <div>
                <h1 class="text-xl font-bold text-gray-800 tracking-tight">TML DOCUMENTS ASSISTANT</h1>
                <p class="text-xs text-gray-400 font-medium">KNOWLEDGE BASE</p>
            </div>
        </div>
        
        <div id="globalStatus" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-500 flex items-center gap-2">
            <span id="statusDot" class="w-2 h-2 rounded-full bg-gray-400"></span>
            <span id="statusText">System Idle</span>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-80 bg-white border-r flex flex-col z-0">
            <div class="p-6">
                <h2 class="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-database text-blue-600"></i> Knowledge Source
                </h2>
                
                <div id="dropZone" class="relative group border-2 border-dashed border-gray-300 rounded-xl h-48 flex flex-col items-center justify-center text-center transition-all duration-300 hover:border-blue-400 hover:bg-blue-50 cursor-pointer overflow-hidden">
                    
                    <input type="file" id="fileInput" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" accept=".txt,.pdf">
                    
                    <div id="stateIdle" class="pointer-events-none transition-opacity duration-300">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-cloud-arrow-up text-xl"></i>
                        </div>
                        <p class="text-sm text-gray-700 font-medium">Click to Upload Documents</p>
                        <p class="text-xs text-gray-400 mt-1">or drag & drop files</p>
                    </div>

                    <div id="stateLoading" class="absolute inset-0 bg-white flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-10">
                        <i class="fa-solid fa-circle-notch fa-spin text-3xl text-blue-600 mb-3"></i>
                        <p class="text-sm text-gray-700 font-bold">Processing...</p>
                        <p class="text-xs text-gray-500 mt-1">Reading & Chunking Data</p>
                    </div>

                    <div id="stateSuccess" class="absolute inset-0 bg-green-50 flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-10">
                        <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fa-solid fa-check text-xl"></i>
                        </div>
                        <p class="text-sm text-green-800 font-bold">Knowledge Base Ready</p>
                        <p class="text-xs text-green-600 mt-1" id="fileCountMsg">Files processed</p>
                        <p class="text-[10px] text-gray-400 mt-4 uppercase font-bold tracking-wider">Drag to update</p>
                    </div>

                </div>
            </div>

            <div class="px-6 py-4 mt-auto bg-gray-50 border-t">
                <div class="text-xs text-gray-500 space-y-2">
                    <p><i class="fa-solid fa-shield-halved mr-1 text-gray-400"></i> Secured Processing</p>
                    <p><i class="fa-solid fa-bolt mr-1 text-gray-400"></i> System Active</p>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-gray-50/50">
            
            <div id="chatBox" class="flex-1 overflow-y-auto p-8 space-y-6 pb-32 scroll-smooth">
                <div id="welcomeScreen" class="text-center mt-24 transition-opacity duration-500">
                    <div class="w-20 h-20 bg-white shadow-sm border border-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <i class="fa-solid fa-robot text-3xl text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">TATA Assistant</h3>
                    <p class="text-gray-400 text-sm mt-2 max-w-sm mx-auto leading-relaxed">
                        I am ready to analyze your documents. Upload files on the left sidebar to begin the conversation.
                    </p>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-gray-50 via-gray-50 to-transparent">
                <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl shadow-blue-900/5 border border-gray-200 p-2 flex items-center gap-2 focus-within:ring-2 focus-within:ring-blue-500/20 transition-all">
                    <input type="text" id="userInput" class="flex-1 border-0 focus:ring-0 text-gray-700 placeholder-gray-400 pl-4 bg-transparent py-3" placeholder="Type your question here..." onkeypress="handleEnter(event)">
                    <button onclick="sendMessage()" id="sendBtn" class="bg-blue-600 text-white w-12 h-12 rounded-xl hover:bg-blue-700 hover:scale-105 active:scale-95 transition-all flex items-center justify-center shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
                <div class="text-center mt-3">
                    <p class="text-[10px] text-gray-400 font-medium tracking-wide">AI GENERATED CONTENT • CHECK FOR ACCURACY</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const stateIdle = document.getElementById('stateIdle');
        const stateLoading = document.getElementById('stateLoading');
        const stateSuccess = document.getElementById('stateSuccess');
        const fileCountMsg = document.getElementById('fileCountMsg');
        
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');

        // --- UNIFIED UPLOAD LOGIC ---
        
        // Handle Drag Visuals
        ['dragenter', 'dragover'].forEach(evt => {
            dropZone.addEventListener(evt, (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });
        });
        ['dragleave', 'drop'].forEach(evt => {
            dropZone.addEventListener(evt, (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });
        });

        // Trigger Upload Immediately on File Selection
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if(files.length > 0) uploadFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            if(e.target.files.length > 0) uploadFiles(e.target.files);
            fileInput.value = ''; // Reset
        });

        async function uploadFiles(files) {
            // 1. UI: Switch to Loading State
            toggleState('loading');
            setStatus('Processing Knowledge Base...', 'yellow');

            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }

            try {
                // 2. Network Request
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();
                
                if(res.ok) {
                    // 3. UI: Switch to Success State
                    fileCountMsg.innerText = `${data.count} chunks indexed`;
                    toggleState('success');
                    setStatus('System Ready', 'green');
                    
                    // Hide Welcome Screen if visible
                    const welcome = document.getElementById('welcomeScreen');
                    if(welcome) welcome.style.opacity = '0';
                    
                } else {
                    alert("Error: " + data.error);
                    toggleState('idle');
                    setStatus('Error processing files', 'red');
                }
            } catch (e) {
                alert("Upload failed. Check server.");
                toggleState('idle');
                setStatus('Connection Error', 'red');
            }
        }

        function toggleState(state) {
            // Reset opacity
            stateIdle.style.opacity = '0';
            stateLoading.style.opacity = '0';
            stateSuccess.style.opacity = '0';
            
            // Remove pointer events
            stateIdle.classList.add('pointer-events-none');
            
            if(state === 'idle') {
                stateIdle.style.opacity = '1';
                stateIdle.classList.remove('pointer-events-none'); // Enable clicking
            } 
            else if (state === 'loading') {
                stateLoading.style.opacity = '1';
            } 
            else if (state === 'success') {
                stateSuccess.style.opacity = '1';
            }
        }

        function setStatus(text, color) {
            statusText.innerText = text;
            statusDot.className = `w-2 h-2 rounded-full bg-${color}-500 animate-pulse`;
            
            const badge = document.getElementById('globalStatus');
            badge.className = `px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 bg-${color}-50 text-${color}-700 transition-colors duration-300`;
        }


        // --- CHAT LOGIC ---
        var last_response = [];

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const chatBox = document.getElementById('chatBox');
            const sendBtn = document.getElementById('sendBtn');
            const msg = input.value.trim();
            
            if(!msg) return;

            // Remove welcome screen completely
            const welcome = document.getElementById('welcomeScreen');
            if(welcome) welcome.style.display = 'none';

            // User Message
            addMessage("You", msg, true);
            input.value = "";

            // Disable input while thinking
            input.disabled = true;
            sendBtn.disabled = true;

            // Bot Thinking Placeholder
            const botMsgDiv = addMessage("TATA Assistant", "", false);
            const contentDiv = botMsgDiv.querySelector('.msg-content');
            
            // Add Bouncing Dots Animation
            contentDiv.innerHTML = `
                <div class="flex items-center h-6 pl-2">
                    <div class="dot-flashing"></div>
                </div>`;

            try {
                console.log(last_response)
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: "```\n" + last_response.join('\n') + "\n```\n" + msg})
                });
                // last_response = response.body
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let isFirstToken = true;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    // last_response ="```"+ lines.join('\n') +"```"
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const data = JSON.parse(line);
                            
                            // IGNORE CONTEXT (Don't display chunks)
                            if (data.type === 'context') {
                                // console.log("Retrieved chunks:", data.data); // Optional Debug
                            } 
                            // DISPLAY TOKENS
                            else if (data.type === 'token') {
                                if (isFirstToken) {
                                    contentDiv.innerHTML = ""; // Remove dots
                                    isFirstToken = false;
                                }
                                contentDiv.innerText += data.content;
                                chatBox.parentElement.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
                            }
                            // last_response = "```" + contentDiv.innerText + "```"
                            
                        } catch (e) {}
                    }
                }
            last_response.push(contentDiv.innerText)
            last_response = last_response.slice(-5)
            } catch (e) {
                contentDiv.innerText = "⚠️ Error connecting to server.";
            }

            // Re-enable input
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }

        function addMessage(sender, text, isUser) {
            const chatBox = document.getElementById('chatBox');
            const div = document.createElement('div');
            
            // Styling based on sender
            const alignClass = isUser ? 'flex-row-reverse' : 'flex-row';
            const bgClass = isUser ? 'bg-white shadow-sm border border-gray-100 text-gray-800' : 'bg-transparent text-gray-800';
            const icon = isUser 
                ? `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center shrink-0 border border-white shadow-sm"><i class="fa-solid fa-user text-gray-500 text-xs"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center shrink-0 shadow-lg shadow-blue-600/20"><i class="fa-solid fa-robot text-white text-xs"></i></div>`;

            div.className = `flex gap-4 ${alignClass} animate-fade-in-up`;
            div.innerHTML = `
                ${icon}
                <div class="${bgClass} px-5 py-3 rounded-2xl max-w-[85%] leading-7 text-[15px]">
                    ${!isUser ? '<div class="text-xs font-bold text-blue-600 mb-1">TATA Assistant</div>' : ''}
                    <div class="msg-content whitespace-pre-wrap">${text}</div>
                </div>
            `;
            chatBox.appendChild(div);
            chatBox.parentElement.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
            return div;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }
        
        // Add fade animation
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in-up {
                animation: fadeInUp 0.3s ease-out forwards;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>