<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tata Documents Assist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-scroll { height: calc(100vh - 300px); overflow-y: auto; }
        .markdown-body { font-family: sans-serif; line-height: 1.6; }
        
        /* Bouncing Dots Animation */
        .dot-flashing {
            position: relative;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9CA3AF;
            color: #9CA3AF;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9CA3AF;
            color: #9CA3AF;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9CA3AF;
            color: #9CA3AF;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dot-flashing {
            0% { background-color: #9CA3AF; }
            50%, 100% { background-color: #E5E7EB; }
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col">

    <header class="bg-white shadow-sm border-b px-6 py-4 flex justify-between items-center z-10">
        <div class="flex items-center gap-3">
             <img src="{{ url_for('static', filename='tata.png') }}" alt="Tata Logo" class="h-10 w-auto object-contain">
            <div>
                <h1 class="text-xl font-bold text-gray-800 tracking-tight">TML DOCUMENTS ASSISTANT</h1>
                <p class="text-xs text-gray-400 font-medium">KNOWLEDGE BASE</p>
            </div>
        </div>
        
        <div id="globalStatus" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-500 flex items-center gap-2">
            <span id="statusDot" class="w-2 h-2 rounded-full bg-gray-400"></span>
            <span id="statusText">System Idle</span>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-80 bg-white border-r flex flex-col z-0">
            <div class="p-6">
                <h2 class="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-database text-blue-600"></i> Knowledge Source
                </h2>
                
                <div id="dropZone" class="relative group border-2 border-dashed border-gray-300 rounded-xl h-48 flex flex-col items-center justify-center text-center transition-all duration-300 hover:border-blue-400 hover:bg-blue-50 cursor-pointer overflow-hidden">
                    
                    <input type="file" id="fileInput" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" accept=".txt,.pdf">
                    
                    <div id="stateIdle" class="pointer-events-none transition-opacity duration-300">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-cloud-arrow-up text-xl"></i>
                        </div>
                        <p class="text-sm text-gray-700 font-medium">Click to Upload Documents</p>
                        <p class="text-xs text-gray-400 mt-1">or drag & drop files</p>
                    </div>

                    <div id="stateLoading" class="absolute inset-0 bg-white flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-10">
                        <i class="fa-solid fa-circle-notch fa-spin text-3xl text-blue-600 mb-3"></i>
                        <p class="text-sm text-gray-700 font-bold">Processing...</p>
                        <p class="text-xs text-gray-500 mt-1">Reading & Chunking Data</p>
                    </div>

                    <div id="stateSuccess" class="absolute inset-0 bg-green-50 flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-10">
                        <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fa-solid fa-check text-xl"></i>
                        </div>
                        <p class="text-sm text-green-800 font-bold">Knowledge Base Ready</p>
                        <p class="text-xs text-green-600 mt-1" id="fileCountMsg">Files processed</p>
                        <p class="text-[10px] text-gray-400 mt-4 uppercase font-bold tracking-wider">Drag to update</p>
                    </div>

                </div>
            </div>

            <div class="px-6 py-4 mt-auto bg-gray-50 border-t">
                <div class="text-xs text-gray-500 space-y-2">
                    <p><i class="fa-solid fa-shield-halved mr-1 text-gray-400"></i> Secured Processing</p>
                    <p><i class="fa-solid fa-bolt mr-1 text-gray-400"></i> System Active</p>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-gray-50/50">
            
            <div id="chatBox" class="flex-1 overflow-y-auto p-8 space-y-6 pb-32 scroll-smooth">
                <div id="welcomeScreen" class="text-center mt-24 transition-opacity duration-500">
                    <div class="w-20 h-20 bg-white shadow-sm border border-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <i class="fa-solid fa-robot text-3xl text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">TATA Assistant</h3>
                    <p class="text-gray-400 text-sm mt-2 max-w-sm mx-auto leading-relaxed">
                        I am ready to analyze your documents. Upload files on the left sidebar to begin the conversation.
                    </p>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-gray-50 via-gray-50 to-transparent">
                <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl shadow-blue-900/5 border border-gray-200 p-2 flex items-center gap-2 focus-within:ring-2 focus-within:ring-blue-500/20 transition-all">
                    <input type="text" id="userInput" class="flex-1 border-0 focus:ring-0 text-gray-700 placeholder-gray-400 pl-4 bg-transparent py-3" placeholder="Type your question here..." onkeypress="handleEnter(event)">
                    <button onclick="sendMessage()" id="sendBtn" class="bg-blue-600 text-white w-12 h-12 rounded-xl hover:bg-blue-700 hover:scale-105 active:scale-95 transition-all flex items-center justify-center shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
                <div class="text-center mt-3">
                    <p class="text-[10px] text-gray-400 font-medium tracking-wide">AI GENERATED CONTENT • CHECK FOR ACCURACY</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const stateIdle = document.getElementById('stateIdle');
        const stateLoading = document.getElementById('stateLoading');
        const stateSuccess = document.getElementById('stateSuccess');
        const fileCountMsg = document.getElementById('fileCountMsg');
        
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');

        // --- UNIFIED UPLOAD LOGIC ---
        
        // Handle Drag Visuals
        ['dragenter', 'dragover'].forEach(evt => {
            dropZone.addEventListener(evt, (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });
        });
        ['dragleave', 'drop'].forEach(evt => {
            dropZone.addEventListener(evt, (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });
        });

        // Trigger Upload Immediately on File Selection
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if(files.length > 0) uploadFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            if(e.target.files.length > 0) uploadFiles(e.target.files);
            fileInput.value = ''; // Reset
        });

        async function uploadFiles(files) {
            // 1. UI: Switch to Loading State
            toggleState('loading');
            setStatus('Processing Knowledge Base...', 'yellow');

            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }

            try {
                // 2. Network Request
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();
                
                if(res.ok) {
                    // 3. UI: Switch to Success State
                    fileCountMsg.innerText = `${data.count} chunks indexed`;
                    toggleState('success');
                    setStatus('System Ready', 'green');
                    
                    // Hide Welcome Screen if visible
                    const welcome = document.getElementById('welcomeScreen');
                    if(welcome) welcome.style.opacity = '0';
                    
                } else {
                    alert("Error: " + data.error);
                    toggleState('idle');
                    setStatus('Error processing files', 'red');
                }
            } catch (e) {
                alert("Upload failed. Check server.");
                toggleState('idle');
                setStatus('Connection Error', 'red');
            }
        }

        function toggleState(state) {
            // Reset opacity
            stateIdle.style.opacity = '0';
            stateLoading.style.opacity = '0';
            stateSuccess.style.opacity = '0';
            
            // Remove pointer events
            stateIdle.classList.add('pointer-events-none');
            
            if(state === 'idle') {
                stateIdle.style.opacity = '1';
                stateIdle.classList.remove('pointer-events-none'); // Enable clicking
            } 
            else if (state === 'loading') {
                stateLoading.style.opacity = '1';
            } 
            else if (state === 'success') {
                stateSuccess.style.opacity = '1';
            }
        }

        function setStatus(text, color) {
            statusText.innerText = text;
            statusDot.className = `w-2 h-2 rounded-full bg-${color}-500 animate-pulse`;
            
            const badge = document.getElementById('globalStatus');
            badge.className = `px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 bg-${color}-50 text-${color}-700 transition-colors duration-300`;
        }


        // --- CHAT LOGIC ---
        var last_response = [];

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const chatBox = document.getElementById('chatBox');
            const sendBtn = document.getElementById('sendBtn');
            const msg = input.value.trim();
            
            if(!msg) return;

            // Remove welcome screen completely
            const welcome = document.getElementById('welcomeScreen');
            if(welcome) welcome.style.display = 'none';

            // User Message
            addMessage("You", msg, true);
            input.value = "";

            // Disable input while thinking
            input.disabled = true;
            sendBtn.disabled = true;

            // Bot Thinking Placeholder
            const botMsgDiv = addMessage("TATA Assistant", "", false);
            const contentDiv = botMsgDiv.querySelector('.msg-content');
            
            // Add Bouncing Dots Animation
            contentDiv.innerHTML = `
                <div class="flex items-center h-6 pl-2">
                    <div class="dot-flashing"></div>
                </div>`;

            try {
                console.log(last_response)
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: "```\n" + last_response.join('\n') + "\n```\n" + msg})
                });
                // last_response = response.body
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let isFirstToken = true;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    // last_response ="```"+ lines.join('\n') +"```"
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const data = JSON.parse(line);
                            
                            // IGNORE CONTEXT (Don't display chunks)
                            if (data.type === 'context') {
                                // console.log("Retrieved chunks:", data.data); // Optional Debug
                            } 
                            // DISPLAY TOKENS
                            else if (data.type === 'token') {
                                if (isFirstToken) {
                                    contentDiv.innerHTML = ""; // Remove dots
                                    isFirstToken = false;
                                }
                                contentDiv.innerText += data.content;
                                chatBox.parentElement.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
                            }
                            // last_response = "```" + contentDiv.innerText + "```"
                            
                        } catch (e) {}
                    }
                }
            last_response.push(contentDiv.innerText)
            last_response = last_response.slice(-5)
            } catch (e) {
                contentDiv.innerText = "⚠️ Error connecting to server.";
            }

            // Re-enable input
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }

        function addMessage(sender, text, isUser) {
            const chatBox = document.getElementById('chatBox');
            const div = document.createElement('div');
            
            // Styling based on sender
            const alignClass = isUser ? 'flex-row-reverse' : 'flex-row';
            const bgClass = isUser ? 'bg-white shadow-sm border border-gray-100 text-gray-800' : 'bg-transparent text-gray-800';
            const icon = isUser 
                ? `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center shrink-0 border border-white shadow-sm"><i class="fa-solid fa-user text-gray-500 text-xs"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center shrink-0 shadow-lg shadow-blue-600/20"><i class="fa-solid fa-robot text-white text-xs"></i></div>`;

            div.className = `flex gap-4 ${alignClass} animate-fade-in-up`;
            div.innerHTML = `
                ${icon}
                <div class="${bgClass} px-5 py-3 rounded-2xl max-w-[85%] leading-7 text-[15px]">
                    ${!isUser ? '<div class="text-xs font-bold text-blue-600 mb-1">TATA Assistant</div>' : ''}
                    <div class="msg-content whitespace-pre-wrap">${text}</div>
                </div>
            `;
            chatBox.appendChild(div);
            chatBox.parentElement.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
            return div;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }
        
        // Add fade animation
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in-up {
                animation: fadeInUp 0.3s ease-out forwards;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tata Documents Assist</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        tata: {
                            blue: '#005EB8', // Official Tata Blueish tone
                            dark: '#0F172A',
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 20px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #94A3B8; }

        /* Bouncing Dots Animation */
        .dot-flashing {
            position: relative;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #fff; /* White for inside the blue bubble */
            color: #fff;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #fff;
            color: #fff;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #fff;
            color: #fff;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dot-flashing {
            0% { opacity: 0.2; }
            50%, 100% { opacity: 1; }
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            backdrop-filter: blur(8px);
            border-right: 1px solid rgba(226, 232, 240, 0.6);
        }
    </style>
</head>
<body class="bg-[#F1F5F9] text-slate-800 h-screen flex flex-col overflow-hidden selection:bg-blue-100 selection:text-blue-900">

    <header class="h-16 glass z-50 flex justify-between items-center px-6 sticky top-0 border-b border-white/50">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center p-1 border border-slate-100">
                 <img src="{{ url_for('static', filename='tata.png') }}" alt="Tata" class="h-full w-auto object-contain">
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800 tracking-tight leading-tight">TML DOCUMENTS ASSISTANT</h1>
                <div class="flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                    <p class="text-[10px] text-slate-400 font-semibold tracking-widest uppercase">Enterprise Knowledge Base</p>
                </div>
            </div>
        </div>

        <div id="globalStatus" class="px-3 py-1.5 rounded-full text-xs font-medium bg-white border border-slate-200 text-slate-500 flex items-center gap-2 shadow-sm transition-all duration-300">
            <span id="statusDot" class="w-2 h-2 rounded-full bg-slate-300"></span>
            <span id="statusText">System Idle</span>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-80 glass-panel flex flex-col z-20 hidden md:flex">
            <div class="p-6 flex flex-col h-full">
                <div class="mb-6">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-layer-group"></i> Data Source
                    </h2>
                    
                    <div id="dropZone" class="relative group border-2 border-dashed border-slate-300 rounded-2xl h-56 flex flex-col items-center justify-center text-center transition-all duration-300 hover:border-blue-500 hover:bg-blue-50/50 cursor-pointer overflow-hidden bg-slate-50">
                        
                        <input type="file" id="fileInput" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" accept=".txt,.pdf">
                        
                        <div id="stateIdle" class="pointer-events-none transition-all duration-300 group-hover:-translate-y-1">
                            <div class="w-14 h-14 bg-white shadow-sm border border-slate-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-3 group-hover:scale-110 group-hover:shadow-md transition-all">
                                <i class="fa-solid fa-cloud-arrow-up text-2xl"></i>
                            </div>
                            <p class="text-sm text-slate-700 font-semibold">Upload Documents</p>
                            <p class="text-xs text-slate-400 mt-1 px-4">Drag PDF or TXT files here to train the AI</p>
                        </div>

                        <div id="stateLoading" class="absolute inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-10">
                            <div class="relative w-12 h-12">
                                <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                                <div class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
                            </div>
                            <p class="text-sm text-slate-700 font-bold mt-4">Analyzing...</p>
                        </div>

                        <div id="stateSuccess" class="absolute inset-0 bg-emerald-50/90 backdrop-blur-sm flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-10">
                            <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-2 animate-bounce">
                                <i class="fa-solid fa-check text-xl"></i>
                            </div>
                            <p class="text-sm text-emerald-800 font-bold">Ready to Chat</p>
                            <p class="text-xs text-emerald-600 mt-1" id="fileCountMsg">Files processed</p>
                        </div>

                    </div>
                </div>

                <div class="mt-auto">
                    <div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-circle-info text-blue-500 mt-0.5"></i>
                            <div class="text-xs text-blue-800 leading-relaxed">
                                <span class="font-bold block mb-1">AI Assistant Tips</span>
                                Upload documents to give the assistant context. The more specific your files, the better the answers.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-[#F8FAFC]">
            
            <div id="chatBox" class="flex-1 overflow-y-auto px-6 py-8 space-y-8 pb-32 scroll-smooth">
                
                <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center text-center -mt-10 transition-opacity duration-500">
                    <div class="w-24 h-24 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-[2rem] shadow-2xl shadow-blue-500/30 flex items-center justify-center mb-8 animate-float">
                        <i class="fa-solid fa-robot text-4xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">How can I help you today?</h3>
                    <p class="text-slate-400 max-w-md leading-relaxed">
                        I am trained on your uploaded documents. Ask me anything about TML specifications, policies, or technical data.
                    </p>
                    
                    <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-lg">
                        <button class="text-left p-4 rounded-xl bg-white border border-slate-100 hover:border-blue-300 hover:shadow-lg hover:-translate-y-0.5 transition-all group">
                            <span class="text-xs font-bold text-slate-400 group-hover:text-blue-500 uppercase">Example</span>
                            <p class="text-sm text-slate-700 font-medium mt-1">Summarize the safety policy</p>
                        </button>
                        <button class="text-left p-4 rounded-xl bg-white border border-slate-100 hover:border-blue-300 hover:shadow-lg hover:-translate-y-0.5 transition-all group">
                            <span class="text-xs font-bold text-slate-400 group-hover:text-blue-500 uppercase">Example</span>
                            <p class="text-sm text-slate-700 font-medium mt-1">What are the engine specs?</p>
                        </button>
                    </div>
                </div>

                </div>

            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#F8FAFC] via-[#F8FAFC] to-transparent z-30">
                <div class="max-w-4xl mx-auto">
                    <div class="relative group">
                        <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-2xl opacity-20 group-hover:opacity-40 blur transition duration-1000 group-hover:duration-200"></div>
                        <div class="relative flex items-center bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 p-2 focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                            
                            <input type="text" id="userInput" 
                                class="flex-1 border-0 focus:ring-0 text-slate-700 placeholder-slate-400 pl-4 bg-transparent py-3 text-base" 
                                placeholder="Ask a question about your documents..." 
                                onkeypress="handleEnter(event)" autocomplete="off">
                            
                            <button onclick="sendMessage()" id="sendBtn" 
                                class="bg-blue-600 text-white w-12 h-12 rounded-xl hover:bg-blue-700 hover:scale-105 active:scale-95 transition-all flex items-center justify-center shadow-lg shadow-blue-600/30 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none">
                                <i class="fa-solid fa-paper-plane text-sm"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-center mt-3 flex justify-center items-center gap-2">
                         <i class="fa-solid fa-sparkles text-xs text-blue-400"></i>
                        <p class="text-[10px] text-slate-400 font-medium tracking-wide">AI GENERATED • VERIFY IMPORTANT INFO</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const stateIdle = document.getElementById('stateIdle');
        const stateLoading = document.getElementById('stateLoading');
        const stateSuccess = document.getElementById('stateSuccess');
        const fileCountMsg = document.getElementById('fileCountMsg');
        
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');

        // --- UNIFIED UPLOAD LOGIC ---
        
        // Handle Drag Visuals
        ['dragenter', 'dragover'].forEach(evt => {
            dropZone.addEventListener(evt, (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });
        });
        ['dragleave', 'drop'].forEach(evt => {
            dropZone.addEventListener(evt, (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });
        });

        // Trigger Upload Immediately on File Selection
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if(files.length > 0) uploadFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            if(e.target.files.length > 0) uploadFiles(e.target.files);
            fileInput.value = ''; // Reset
        });

        async function uploadFiles(files) {
            // 1. UI: Switch to Loading State
            toggleState('loading');
            setStatus('Processing...', 'yellow');

            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }

            try {
                // 2. Network Request
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();
                
                if(res.ok) {
                    // 3. UI: Switch to Success State
                    fileCountMsg.innerText = `${data.count} chunks indexed`;
                    toggleState('success');
                    setStatus('System Ready', 'emerald');
                    
                    // Hide Welcome Screen if visible
                    const welcome = document.getElementById('welcomeScreen');
                    if(welcome) welcome.style.opacity = '0';
                    setTimeout(() => { if(welcome) welcome.style.display = 'none'; }, 500);
                    
                } else {
                    alert("Error: " + data.error);
                    toggleState('idle');
                    setStatus('Error processing', 'red');
                }
            } catch (e) {
                alert("Upload failed. Check server.");
                toggleState('idle');
                setStatus('Connection Error', 'red');
            }
        }

        function toggleState(state) {
            // Reset opacity
            stateIdle.style.opacity = '0';
            stateLoading.style.opacity = '0';
            stateSuccess.style.opacity = '0';
            
            // Remove pointer events
            stateIdle.classList.add('pointer-events-none');
            
            if(state === 'idle') {
                stateIdle.style.opacity = '1';
                stateIdle.classList.remove('pointer-events-none'); 
            } 
            else if (state === 'loading') {
                stateLoading.style.opacity = '1';
            } 
            else if (state === 'success') {
                stateSuccess.style.opacity = '1';
            }
        }

        function setStatus(text, color) {
            const colors = {
                'yellow': 'bg-amber-400',
                'emerald': 'bg-emerald-500',
                'red': 'bg-red-500',
                'slate': 'bg-slate-300'
            };
            const badgeColors = {
                 'yellow': 'bg-amber-50 text-amber-600 border-amber-200',
                 'emerald': 'bg-emerald-50 text-emerald-600 border-emerald-200',
                 'red': 'bg-red-50 text-red-600 border-red-200',
                 'slate': 'bg-white text-slate-500 border-slate-200'
            };
            
            statusText.innerText = text;
            statusDot.className = `w-2 h-2 rounded-full ${colors[color] || colors['slate']} ${color === 'yellow' ? 'animate-pulse' : ''}`;
            
            const badge = document.getElementById('globalStatus');
            // Remove old classes and add new ones
            badge.className = `px-3 py-1.5 rounded-full text-xs font-medium border flex items-center gap-2 shadow-sm transition-all duration-300 ${badgeColors[color] || badgeColors['slate']}`;
        }


        // --- CHAT LOGIC ---
        var last_response = [];

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const chatBox = document.getElementById('chatBox');
            const sendBtn = document.getElementById('sendBtn');
            const msg = input.value.trim();
            
            if(!msg) return;

            // Remove welcome screen completely
            const welcome = document.getElementById('welcomeScreen');
            if(welcome) welcome.style.display = 'none';

            // User Message
            addMessage("You", msg, true);
            input.value = "";

            // Disable input while thinking
            input.disabled = true;
            sendBtn.disabled = true;

            // Bot Thinking Placeholder
            const botMsgDiv = addMessage("TATA Assistant", "", false);
            const contentDiv = botMsgDiv.querySelector('.msg-content');
            
            // Add Bouncing Dots Animation
            contentDiv.innerHTML = `
                <div class="flex items-center h-6 pl-1">
                    <div class="dot-flashing"></div>
                </div>`;

            try {
                // console.log(last_response)
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: "```\n" + last_response.join('\n') + "\n```\n" + msg})
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let isFirstToken = true;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const data = JSON.parse(line);
                            
                            // IGNORE CONTEXT (Don't display chunks)
                            if (data.type === 'context') {
                                // console.log("Retrieved chunks:", data.data); 
                            } 
                            // DISPLAY TOKENS
                            else if (data.type === 'token') {
                                if (isFirstToken) {
                                    contentDiv.innerHTML = ""; // Remove dots
                                    isFirstToken = false;
                                }
                                contentDiv.innerText += data.content;
                                
                                // Scroll to bottom efficiently
                                const main = chatBox.parentElement;
                                if(main) main.scrollTo({ top: main.scrollHeight, behavior: 'smooth' });
                            }
                            
                        } catch (e) {}
                    }
                }
                last_response.push(contentDiv.innerText)
                last_response = last_response.slice(-5)
            } catch (e) {
                contentDiv.innerText = "⚠️ Error connecting to server. Please try again.";
                contentDiv.classList.add("text-red-200");
            }

            // Re-enable input
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }

        function addMessage(sender, text, isUser) {
            const chatBox = document.getElementById('chatBox');
            const div = document.createElement('div');
            
            // Styling based on sender
            const alignClass = isUser ? 'justify-end' : 'justify-start';
            
            // Aesthetic Message Bubbles
            // User: White bubble, dark text, sharp corner top-right
            // Bot: Gradient Blue bubble, white text, sharp corner top-left
            const bubbleClass = isUser 
                ? 'bg-white text-slate-800 rounded-2xl rounded-tr-sm border border-slate-100 shadow-sm' 
                : 'bg-gradient-to-br from-blue-600 to-indigo-600 text-white rounded-2xl rounded-tl-sm shadow-md shadow-blue-500/20';

            const icon = isUser 
                ? `<div class="w-8 h-8 rounded-full bg-slate-100 border border-white flex items-center justify-center shrink-0 shadow-sm"><i class="fa-solid fa-user text-slate-400 text-xs"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-blue-600 border-2 border-white flex items-center justify-center shrink-0 shadow-lg shadow-blue-500/30"><i class="fa-solid fa-robot text-white text-xs"></i></div>`;

            div.className = `flex gap-3 w-full ${alignClass} animate-fade-in-up group`;
            
            // Layout Order
            const innerHTML = isUser 
                ? `
                    <div class="max-w-[85%] sm:max-w-[75%]">
                        <div class="${bubbleClass} px-6 py-3.5 leading-7 text-[15px]">
                            <div class="msg-content whitespace-pre-wrap">${text}</div>
                        </div>
                        <p class="text-[10px] text-slate-300 font-medium mt-1 text-right mr-1 opacity-0 group-hover:opacity-100 transition-opacity">You</p>
                    </div>
                    ${icon}
                  `
                : `
                    ${icon}
                    <div class="max-w-[85%] sm:max-w-[75%]">
                        <div class="${bubbleClass} px-6 py-3.5 leading-7 text-[15px]">
                            <div class="msg-content whitespace-pre-wrap">${text}</div>
                        </div>
                         <p class="text-[10px] text-slate-300 font-medium mt-1 ml-1 opacity-0 group-hover:opacity-100 transition-opacity">Tata Assistant</p>
                    </div>
                  `;

            div.innerHTML = innerHTML;
            chatBox.appendChild(div);
            
            // Scroll to bottom
            const main = chatBox.parentElement;
            if(main) main.scrollTo({ top: main.scrollHeight, behavior: 'smooth' });
            
            return div;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }
        
        // Add fade animation via JS injection (cleaner than inline style block)
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in-up {
                animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html> {% endcomment %}